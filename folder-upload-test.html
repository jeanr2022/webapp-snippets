<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folder Upload Dialog Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 20px;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .methods-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .method-box {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-container {
            display: flex;
            gap: 20px;
        }
        
        .result-column {
            flex: 1;
            min-width: 0;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        button:hover {
            background-color: #106ebe;
        }
        
        #output {
            margin-top: 20px;
        }
        
        .info-section {
            background-color: #f9f9f9;
            border-left: 4px solid #0078d4;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .file-item {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .file-property {
            margin: 5px 0;
        }
        
        .property-label {
            font-weight: bold;
            color: #0078d4;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }
        
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        th {
            background-color: #0078d4;
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Folder Upload Dialog Test</h1>
        <p>Compare both folder selection APIs side by side to see how they handle different scenarios, especially long paths.</p>
    </div>
    
    <div class="methods-container">
        <div class="method-box">
            <h3>Method 1: HTML5 File API (webkitdirectory)</h3>
            <p style="font-size: 14px; color: #666;">Broader browser support, uses &lt;input&gt; element</p>
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
            <button onclick="document.getElementById('folderInput').click()">Select Folder (File API)</button>
        </div>
        
        <div class="method-box">
            <h3>Method 2: File System Access API (showDirectoryPicker)</h3>
            <p style="font-size: 14px; color: #666;">Modern standard, Chromium-based browsers only</p>
            <button onclick="selectFolderModern()">Select Folder (File System Access API)</button>
        </div>
    </div>
    
    <div class="results-container">
        <div class="result-column" id="output1"></div>
        <div class="result-column" id="output2"></div>
    </div>

    <script>
        // Method 1: HTML5 File API with webkitdirectory
        document.getElementById('folderInput').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            displayResults(files, 'HTML5 File API (webkitdirectory)', null, 'output1');
        });
        
        // Method 2: File System Access API
        async function selectFolderModern() {
            try {
                // Check if API is supported
                if (!window.showDirectoryPicker) {
                    alert('File System Access API is not supported in this browser. Please use a Chromium-based browser (Chrome, Edge).');
                    return;
                }
                
                const dirHandle = await window.showDirectoryPicker();
                const files = await getAllFiles(dirHandle);
                displayResults(files, 'File System Access API (showDirectoryPicker)', dirHandle, 'output2');
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('User cancelled folder selection');
                } else {
                    console.error('Error accessing folder:', err);
                    const output = document.getElementById('output2');
                    output.innerHTML = `<div class="info-section" style="background-color: #fff3cd; border-left-color: #ffc107;">
                        <h2>Error</h2>
                        <div class="file-property"><span class="property-label">Error name:</span> ${err.name}</div>
                        <div class="file-property"><span class="property-label">Error message:</span> ${err.message}</div>
                    </div>`;
                }
            }
        }
        
        async function getAllFiles(dirHandle, path = '') {
            const files = [];
            
            for await (const entry of dirHandle.values()) {
                const entryPath = path ? `${path}/${entry.name}` : entry.name;
                
                if (entry.kind === 'file') {
                    try {
                        const file = await entry.getFile();
                        // Add relative path property to match File API behavior
                        file.relativePath = entryPath;
                        files.push(file);
                    } catch (err) {
                        console.error(`Error reading file ${entryPath}:`, err);
                        // Create error placeholder
                        files.push({
                            name: entry.name,
                            relativePath: entryPath,
                            size: 0,
                            type: 'error',
                            lastModified: 0,
                            error: err.message
                        });
                    }
                } else if (entry.kind === 'directory') {
                    const subFiles = await getAllFiles(entry, entryPath);
                    files.push(...subFiles);
                }
            }
            
            return files;
        }
        
        function displayResults(files, apiMethod, dirHandle = null, outputId = 'output') {
            const output = document.getElementById(outputId);
            
            // Clear previous output
            output.innerHTML = '';
            
            // Display API method used
            const methodDiv = document.createElement('div');
            methodDiv.className = 'info-section';
            methodDiv.style.backgroundColor = '#e7f3ff';
            methodDiv.innerHTML = `<h2>API Method Used: ${apiMethod}</h2>`;
            output.appendChild(methodDiv);
            
            // Display summary information
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'info-section';
            const totalSize = getTotalSize(files);
            const errorCount = files.filter(f => f.error).length;
            summaryDiv.innerHTML = `
                <h2>Summary</h2>
                <div class="file-property"><span class="property-label">Total files selected:</span> ${files.length}</div>
                ${errorCount > 0 ? `<div class="file-property" style="color: #d9534f;"><span class="property-label">Files with errors:</span> ${errorCount}</div>` : ''}
                <div class="file-property"><span class="property-label">Total size:</span> ${formatBytes(totalSize)}</div>
            `;
            output.appendChild(summaryDiv);
            
            // Display FileList object information
            const fileListDiv = document.createElement('div');
            fileListDiv.className = 'info-section';
            fileListDiv.innerHTML = `
                <h2>Collection Information</h2>
                <div class="file-property"><span class="property-label">Object type:</span> ${files.constructor.name}</div>
                <div class="file-property"><span class="property-label">Length:</span> ${files.length}</div>
                ${dirHandle ? `<div class="file-property"><span class="property-label">Directory name:</span> ${dirHandle.name}</div>` : ''}
            `;
            output.appendChild(fileListDiv);
            
            // Create detailed file table
            if (files.length > 0) {
                const tableDiv = document.createElement('div');
                tableDiv.className = 'info-section';
                tableDiv.innerHTML = '<h2>Detailed File Information</h2>';
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Relative Path</th>
                            <th>Size</th>
                            <th>Type</th>
                            <th>Last Modified</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody_${outputId}"></tbody>
                `;
                
                tableDiv.appendChild(table);
                output.appendChild(tableDiv);
                
                const tbody = document.getElementById(`fileTableBody_${outputId}`);
                
                // Iterate through all files
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const row = tbody.insertRow();
                    
                    const pathValue = file.webkitRelativePath || file.relativePath || 'N/A';
                    const sizeValue = file.error ? `ERROR: ${file.error}` : formatBytes(file.size);
                    const rowStyle = file.error ? 'style="background-color: #ffebee;"' : '';
                    
                    row.innerHTML = `
                        <td ${rowStyle}>${i + 1}</td>
                        <td ${rowStyle}>${file.name}</td>
                        <td ${rowStyle}>${pathValue}</td>
                        <td ${rowStyle}>${sizeValue}</td>
                        <td ${rowStyle}>${file.type || 'N/A'}</td>
                        <td ${rowStyle}>${file.lastModified ? new Date(file.lastModified).toLocaleString() : 'N/A'}</td>
                    `;
                }
                
                // Display File object properties for the first file as example
                if (files.length > 0) {
                    const firstFile = files[0];
                    const exampleDiv = document.createElement('div');
                    exampleDiv.className = 'info-section';
                    exampleDiv.innerHTML = `
                        <h2>Example File Object Properties (First File)</h2>
                        <div class="file-property"><span class="property-label">name:</span> ${firstFile.name}</div>
                        <div class="file-property"><span class="property-label">size:</span> ${firstFile.size} bytes</div>
                        <div class="file-property"><span class="property-label">type:</span> ${firstFile.type || '(empty string)'}</div>
                        <div class="file-property"><span class="property-label">lastModified:</span> ${firstFile.lastModified}</div>
                        <div class="file-property"><span class="property-label">lastModifiedDate:</span> ${firstFile.lastModifiedDate || 'undefined'}</div>
                        <div class="file-property"><span class="property-label">webkitRelativePath:</span> ${firstFile.webkitRelativePath || 'undefined'}</div>
                        <div class="file-property"><span class="property-label">relativePath (File System API):</span> ${firstFile.relativePath || 'undefined'}</div>
                        ${firstFile.error ? `<div class="file-property" style="color: #d9534f;"><span class="property-label">error:</span> ${firstFile.error}</div>` : ''}
                    `;
                    output.appendChild(exampleDiv);
                }
                
                // Display folder structure
                displayFolderStructure(files, output);
                
                // Display path length analysis
                displayPathAnalysis(files, output);
            } else {
                const noFilesDiv = document.createElement('div');
                noFilesDiv.className = 'info-section';
                noFilesDiv.style.backgroundColor = '#fff3cd';
                noFilesDiv.style.borderLeftColor = '#ffc107';
                noFilesDiv.innerHTML = `
                    <h2>‚ö†Ô∏è Warning: No Files Returned</h2>
                    <p>The API returned 0 files. This could indicate:</p>
                    <ul>
                        <li>Empty folder selected</li>
                        <li>Path length exceeds 260 characters (Windows MAX_PATH limitation)</li>
                        <li>Permission issues accessing the folder</li>
                        <li>Hidden files only (not accessible via File API)</li>
                    </ul>
                `;
                output.appendChild(noFilesDiv);
            }
        }
        
        function displayPathAnalysis(files, output) {
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'info-section';
            analysisDiv.innerHTML = '<h2>Path Length Analysis</h2>';
            
            let maxPathLength = 0;
            let maxPathFile = null;
            let pathsOver260 = 0;
            
            files.forEach(file => {
                const path = file.webkitRelativePath || file.relativePath || '';
                if (path.length > maxPathLength) {
                    maxPathLength = path.length;
                    maxPathFile = file;
                }
                if (path.length > 260) {
                    pathsOver260++;
                }
            });
            
            const warningStyle = pathsOver260 > 0 ? 'style="color: #d9534f; font-weight: bold;"' : '';
            
            analysisDiv.innerHTML += `
                <div class="file-property"><span class="property-label">Longest path length:</span> ${maxPathLength} characters</div>
                ${maxPathFile ? `<div class="file-property"><span class="property-label">Longest path file:</span> ${maxPathFile.name}</div>` : ''}
                <div class="file-property" ${warningStyle}><span class="property-label">Paths exceeding 260 chars (Windows MAX_PATH):</span> ${pathsOver260}</div>
                ${pathsOver260 > 0 ? '<div class="file-property" style="color: #d9534f;">‚ö†Ô∏è Long paths may cause issues on Windows systems</div>' : ''}
            `;
            
            output.appendChild(analysisDiv);
        }
        
        function getTotalSize(files) {
            let total = 0;
            for (let i = 0; i < files.length; i++) {
                if (!files[i].error) {
                    total += files[i].size;
                }
            }
            return total;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }
        
        function displayFolderStructure(files, output) {
            const structureDiv = document.createElement('div');
            structureDiv.className = 'info-section';
            structureDiv.innerHTML = '<h2>Folder Structure</h2>';
            
            // Build folder tree
            const folders = new Set();
            for (let i = 0; i < files.length; i++) {
                const path = files[i].webkitRelativePath || files[i].relativePath || '';
                if (path) {
                    const pathParts = path.split('/');
                    let currentPath = '';
                    for (let j = 0; j < pathParts.length - 1; j++) {
                        currentPath += (currentPath ? '/' : '') + pathParts[j];
                        folders.add(currentPath);
                    }
                }
            }
            
            const folderList = Array.from(folders).sort();
            const pre = document.createElement('pre');
            pre.style.backgroundColor = '#f5f5f5';
            pre.style.padding = '10px';
            pre.style.borderRadius = '4px';
            pre.style.overflow = 'auto';
            
            let treeText = '';
            folderList.forEach(folder => {
                const depth = folder.split('/').length - 1;
                const indent = '  '.repeat(depth);
                const folderName = folder.split('/').pop();
                treeText += indent + 'üìÅ ' + folderName + '\n';
            });
            
            pre.textContent = treeText || 'No folder structure detected';
            structureDiv.appendChild(pre);
            output.appendChild(structureDiv);
        }
    </script>
</body>
</html>
